<%@ Page Language="C#" AutoEventWireup="true" Title="Autogenerated Code Settings" MasterPageFile="~/Meta/MetaMain.Master" CodeBehind="AutoGenerateCode_Add.aspx.cs" Inherits="SensysErp.Meta.AutoGenerateCode_Add" ValidateRequest="false" %>

<%@ Register Assembly="Telerik.Web.UI" Namespace="Telerik.Web.UI" TagPrefix="telerik" %>


<asp:Content ID="Content1" ContentPlaceHolderID="head" runat="server">

    <%# HelperLib.Web.WebResources.GetResource("~/css/layout_grid.css")%>
    <%# HelperLib.Web.WebResources.GetResource("~/Scripts/knockout-2.2.1.js")%>

    <script type="text/javascript">
        var DashboardID = "";
        var AddMode = false;

        var dbCols = [];
        var dispname = "";
        var entitypath = "";
        var reservedKeywords = ["recordid", "entityname", "_preview"];

    </script>


    <style>
        #tvCtrEnt
        {
            position: absolute;
            display: none;
            width: 298px;
            height: 295px;
            border: solid 1px #DBD7D7;
            z-index: 10;
            box-shadow: 2px 2px 5px #555;
            overflow-y: auto;
            margin-top: -5px;
            background-color: #FFFFF5;
        }

        #tvCtrFld
        {
            position: absolute;
            display: none;
            width: 298px;
            height: 295px;
            border: solid 1px #DBD7D7;
            z-index: 10;
            box-shadow: 2px 2px 5px #555;
            overflow-y: auto;
            margin-top: -5px;
            background-color: #FFFFF5;
        }

        #txtEntity
        {
            width: 288px;
            padding: 5px;
            font-size: 14px;
            color: #983434;
            margin-bottom: 5px;
            cursor: pointer;
            border: solid 1px #808080;
        }

        #rtvList
        {
            border: solid 1px #808080;
        }

        .divAutoGenerated
        {
            display: none;
            position: absolute;
            border: 1px solid #8B8B8B;
            width: 700px;
            top: 25px !important;
            padding: 20px;
        }

        .reToolbar
        {
            display: none;
        }

        .reModule
        {
            display: none;
        }

        .divTreeButton
        {
            height: 24px;
            width: 24px;
            font-family: fontawesome;
            font-size: 18px;
            font-weight: normal;
            position: absolute;
            margin-top: 0px;
            display: inline-block;
            vertical-align: top;
            padding-left: 2px;
        }

        .divAdvTreeSimple
        {
            height: 24px;
            width: 24px;
            font-family: fontawesome;
            font-size: 18px;
            font-weight: normal;
            display: inline-block;
        }

        .divTree
        {
            display: none;
            position: absolute;
            border: 1px solid #A1A1A1;
            height: 250px;
            width: 250px;
            overflow: auto;
            overflow-x: hidden;
            background-color: #F0F0F0;
            z-index: 100;
            box-shadow: 1px 1px 5px #555;
        }

        .DarkTheme .divTree
        {
            background-color: #414141;
        }

        .RedTheme .divTree
        {
            background-color: #F0ECE8;
        }

        .GreenTheme .divTree
        {
            background-color: #DEF7CB;
        }

        .BlueGlossTheme .divTree
        {
            background-color: #97c9f8;
        }

        .OrangeTheme .divTree
        {
            background-color: #FFE9D5;
        }

        #divPopup
        {
            display: none;
            position: fixed;
            z-index: 3500;
            padding: 20px;
            height: 100px;
            width: 350px;
        }

        #divEditor
        {
            display: none;
            position: absolute;
            z-index: 3500;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #fff;
        }

        .tblSeries
        {
            max-height: 170px;
            overflow-y: auto;
            vertical-align: top;
        }

        #tbl .td-value
        {
            padding: 0 5px;
        }

        .divCriteriaCss
        {
            width: 300px;
            vertical-align: top;
        }

        .Office2007.reWrapper, .Office2007.RadEditor .reContentCell, .Office2007.reColorPicker, .Office2007.reInsertTable, .Office2007.reCustomLinks a:hover
        {
            border: 0;
        }

        .reContentCell iframe
        {
            height: 33px !important;
        }

        .table-form .RadEditor TD
        {
            padding: 0;
        }
    </style>

</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="ContentPlaceHolder1" runat="server">
    <asp:UpdatePanel ID="UpdatePanel1" runat="server">
        <ContentTemplate>
            <hlp:ActionMessage ID="ActionMessage1" runat="server" />


            <div class="div-form">
                <table id="tdvalue" class="table-form" style="width: 510px;">

                    <tr>
                        <td class="td-label">
                            <asp:Label ID="lblEntity" runat="server" Text="Entity"></asp:Label>
                        </td>
                        <td class="td-value">
                            <asp:TextBox ID="txtEntity" runat="server" ReadOnly="true"></asp:TextBox>
                            <div id="tvCtrEnt">
                                <telerik:RadTreeView ID="tvEntity" OnClientNodeClicked="selectEntity" runat="server">
                                </telerik:RadTreeView>
                            </div>
                            <asp:HiddenField ID="hdnEntityID" runat="server" />
                        </td>
                    </tr>

                    <tr>
                        <td class="td-label">
                            <asp:Label ID="lblFieldName" runat="server" Text="Field Name"></asp:Label>
                        </td>
                        <td class="td-value">
                            <asp:TextBox ID="txtFieldName" runat="server" ReadOnly="true"></asp:TextBox>
                            <div id="tvCtrFld">
                                <telerik:RadTreeView ID="rtvList" runat="server" OnClientNodeClicked="selectField" OnClientNodePopulating="tvItems_NodePopulate">
                                    <WebServiceSettings Path="AutoGenerateCode_Add.aspx" Method="GetEntityFields"></WebServiceSettings>
                                </telerik:RadTreeView>
                            </div>
                            <asp:HiddenField ID="hdnFieldID" runat="server" />
                        </td>
                    </tr>

                    <tr>
                        <td class="td-label">Is Deactivated</td>
                        <td class="td-value">
                            <asp:CheckBox ID="chkIsDeactivated" data-chk-on="yes" data-chk-off="no" runat="server"></asp:CheckBox>
                        </td>
                    </tr>

                    <tr>
                        <td class="td-label">Disable Auto Code</td>
                        <td class="td-value">
                            <asp:CheckBox ID="chkDisableAutoCode" data-chk-on="yes" data-chk-off="no" runat="server" onChange="CheckAutoGenarateCode();"></asp:CheckBox>
                        </td>
                    </tr>


                    <tr id="trCriteria" runat="server">
                        <td class="td-label">Criteria </td>
                        <td>
                            <table style="margin-top: -7px;">
                                <tr>
                                    <td style="vertical-align: top; padding: 0;" class="td-label">
                                        <div class="divCriteriaCss">
                                            <table id="tblCriteria">
                                                <tr class="trCriteria">
                                                    <td class="td-value">
                                                        <a href="javascript:void(0)" onclick="return LaunchCriteriaFilter(this)" class="default-link" id="crno">Criteria No 1</a>
                                                    </td>
                                                    <td>&nbsp;&nbsp;&nbsp;</td>
                                                    <td class="td-value">
                                                        <a href="javascript:void(0)" onclick="return LaunchCriteriaCode(this)" class="default-link" id="crcode">Settings</a>
                                                    </td>
                                                    <td>
                                                        <a class="close" title="Delete" href="javascrpt:void(0)" onclick="return CriteriaDelete(this)">X</a>
                                                    </td>
                                                    <td>
                                                        <div class="divCriteriaFilterValue" style="display: none"></div>
                                                        <div class="divCriteriaCodeValue" style="display: none"></div>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                        <a href="javascript:void(0)" onclick="return AddNewCriteria(this)" style="color: #F00; margin-left: 5px; font-size: 15px;" class="default-link">Add New Criteria</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                </table>
            </div>



            <div>
                <asp:LinkButton ID="btnSubmit" CssClass="cmdBtn cmdSave" runat="server" Text="Submit" OnClientClick="return saveData();"></asp:LinkButton>
                <asp:LinkButton ID="btnClose" class="cmdBtn cmdClose" runat="server" Text="Cancel" OnClientClick="closeForm();"></asp:LinkButton>
            </div>

            <div class="filter" id="divFilter" style="background-color: #fff; padding: 5px 5px 5px 5px; display: none; top: 25px !important; height: 450px; width: 770px">
                <iframe id="IfrmFilter" frameborder="0" runat="server" style="height: 98%; width: 98%"></iframe>
            </div>

            <div id="divAutoGenerated" class="divAutoGenerated">
                <table class="table-form">

                    <tr>
                        <td class="td-label" style="vertical-align: middle"><span>Numbering Mode</span></td>
                        <td class="td-label">
                            <asp:RadioButtonList ID="rblSeries" runat="server" RepeatDirection="Horizontal" onchange="return ChangeSimpleSeries()">
                                <asp:ListItem Text="Simple" Value="0" Selected="True"></asp:ListItem>
                                <asp:ListItem Text="Series" Value="1"></asp:ListItem>
                            </asp:RadioButtonList>
                        </td>
                    </tr>
                    <tr id="trNumberStart" runat="server">
                        <td class="td-label">
                            <asp:Label ID="lblNumber" runat="server" Text="Start Number"></asp:Label>
                        </td>
                        <td class="td-value">
                            <telerik:RadNumericTextBox ID="ntxtNumberStart" runat="server" ShowSpinButtons="false" Width="45px"></telerik:RadNumericTextBox>
                        </td>
                    </tr>
                    <tr id="trSeries">
                        <td class="td-label" style="vertical-align: top">Criteria</td>
                        <td>
                            <div class="tblSeries div-form" style="width: 550px">
                                <table style="vertical-align: top">
                                    <thead>
                                        <tr>
                                            <%--<th></th>--%>
                                            <th class="td-label">Series Key</th>
                                            <th class="td-label">Value</th>
                                            <th class="td-label">Start Number</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbl" data-bind="foreach: FilterTask, visible: FilterTask().length > 0">
                                        <tr>
                                            <td class="td-value">
                                                <asp:TextBox ID="TextBox1" runat="server" ReadOnly="true" onfocus="ShowFieldInfoTree(this, 'Series')" CssClass="seriesField" data-bind="value: FieldName, attr: { title : Title}" Style="width: 130px" epname="abc"></asp:TextBox>
                                            </td>
                                            <td class="td-value">
                                                <asp:TextBox ID="txtSeriesValue" data-bind="value: SeriesValue" CssClass="srsValue" runat="server" Style="width: 130px"></asp:TextBox>
                                            </td>
                                            <td class="td-value">
                                                <asp:TextBox ID="txtSeriesStartNumber" CssClass="srsNumber" data-bind="value: SeriesStart" runat="server" Style="width: 130px"></asp:TextBox>
                                            </td>
                                            <td>
                                                <a class="close" href="javascript:void(0)" title="Delete" data-bind="click: $parent.removeTask">X</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="td-label">
                            <asp:Label ID="lblResetNumbering" runat="server" Text="Reset Numbering"></asp:Label>
                        </td>
                        <td class="td-value">
                            <asp:TextBox ID="txtReset" onfocus="ShowFieldInfoTree(this, 'Fields')" runat="server" CssClass="LiveTree"></asp:TextBox>
                            <label title="To be used if numbering needs to be reset on year or month change" style="margin-left: 15px; vertical-align: middle" for="chkPrefixChange">Reset On Prefix Change</label><input style="margin-left: 3px; vertical-align: middle" id="chkPrefixChange" type="checkbox" />
                            <label title="To be used if numbering needs to be reset on year or month change" style="margin-left: 15px; vertical-align: middle" for="chkSuffixChange">Reset On Suffix Change</label><input style="margin-left: 3px; vertical-align: middle" id="chkSuffixChange" type="checkbox" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="td-label">
                            <asp:CheckBox ID="chkPrefill" TextAlign="Left" data-chk-off="No" data-chk-on="Yes" runat="server" Text="Allow prefill characters " onclick="return CheckPrefill()" />
                        </td>
                    </tr>
                    <tr id="trPrefillLen" runat="server">
                        <td class="td-label">
                            <asp:Label ID="lblPrefillLength" runat="server" Text="Prefill Length"></asp:Label>
                        </td>
                        <td class="td-value">
                            <telerik:RadNumericTextBox ID="ntxtPrefillLength" runat="server" ShowSpinButtons="false" Width="45px"></telerik:RadNumericTextBox>
                        </td>
                    </tr>
                    <tr id="trPrefillChar" runat="server">
                        <td class="td-label">
                            <asp:Label ID="lblPrefillChar" runat="server" Text="Prefill Character"></asp:Label>
                        </td>
                        <td class="td-value">
                            <asp:TextBox ID="txtPrefillChar" runat="server" MaxLength="1" Text="0"></asp:TextBox>
                        </td>

                    </tr>
                    <tr>
                        <td class="td-label">
                            <asp:Label ID="lblPrefix" runat="server" Text="Prefix"></asp:Label>
                        </td>
                        <td class="td-value">
                            <%--<telerik:RadEditor ID="edPrefix" runat="server" Skin="Office2007" OnClientPasteHtml="PasteCancel" ToolbarMode="Default" EditModes="Design" Width="450px" Height="27px" ContentFilters="None">
                            </telerik:RadEditor>--%>

                            <telerik:RadTextBox ID="edPrefix" runat="server" Width="388px" TextMode="MultiLine" Height="45px"></telerik:RadTextBox>

                            <div class="divTreeButton" title="Click here to set Prefix" style="cursor: pointer" onclick="ShowFieldInfoTree(this, 'Prefix')">&#xf0c9;</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="td-label">
                            <asp:Label ID="lblsuffix" runat="server" Text="Suffix"></asp:Label>
                        </td>
                        <td class="td-value">
                            <%--   <telerik:RadEditor ID="edSuffix" runat="server" Skin="Office2007" ToolbarMode="Default" OnClientPasteHtml="PasteCancel" EditModes="Design" Width="450px" Height="27px" ContentFilters="None">
                            </telerik:RadEditor>--%>

                            <telerik:RadTextBox ID="edSuffix" runat="server" Width="388px" TextMode="MultiLine" Height="45px"></telerik:RadTextBox>

                            <div class="divTreeButton" title="Click here to set Suffix" style="cursor: pointer" onclick="ShowFieldInfoTree(this, 'Suffix')">&#xf0c9;</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="td-label" colspan="2">
                            <asp:CheckBox ID="chkAllowMod" runat="server" TextAlign="Left" data-chk-off="No" data-chk-on="Yes" Text="Allow modifications by user " />
                        </td>
                    </tr>
                </table>
                <br />
                <div class="cmdPanel">
                    <asp:LinkButton ID="lbnCriteriaSubmit" CssClass="cmdBtn cmdSave" runat="server" Text="Save" OnClientClick="return SaveCriteriaCode()"></asp:LinkButton>
                    <a href="javascript:void(0)" class="cmdBtn cmdClose" onclick="$('#divAutoGenerated').HideModal()">Cancel</a>
                </div>

                <div id="divTree" class="divTree">
                    <telerik:RadTreeView ID="tvRelated" CssClass="tree" OnClientNodeClicking="LoadTreeDatatoControls" OnClientNodeClicked="HideFieldInfoTree" OnClientNodePopulating="tvItems_NodePopulate" Style="overflow-x: hidden !important; height: 100% !important; width: 100% !important;" runat="server">
                        <WebServiceSettings Path="AutoGenerateCode_Add.aspx" Method="GetNodes"></WebServiceSettings>
                        <Nodes>
                        </Nodes>
                    </telerik:RadTreeView>
                </div>
            </div>
            <asp:Button ID="btnLoadEntities" runat="server" Style="display: none" OnClick="btnLoadEntities_Click" />
            <asp:HiddenField ID="hdnRecordFilter" runat="server" />
            <asp:HiddenField ID="hdnSaveCriteria" runat="server" />
            <asp:HiddenField ID="hdnDependentFilter" runat="server" />
            <asp:HiddenField ID="hdnAdvSubQryFilter" runat="server" />
            <asp:HiddenField ID="hdnSingleSelectOldTable" runat="server" />


        </ContentTemplate>
    </asp:UpdatePanel>

    <script type="text/javascript">



    </script>

    <script type="text/javascript">

        var ajx = Sys.WebForms.PageRequestManager.getInstance();
        ajx.add_pageLoaded(function () {
            if (typeof MDI != "undefined") {
                //Add user code here
                //alert("load "+MDI.id );             
            }
        })

        ajx.add_endRequest(function () {
            if (typeof MDI != "undefined") {
                //Add user code here
                //alert("load "+MDI.id );   
                CloseWindow();
            }
        })
    </script>

    <script type="text/javascript">
        var entityId = "", entityName = "";

        function pageLoad() {
            LoadCriteriaData();
            $("#<%=chkDisableAutoCode.ClientID%>").CheckBoxX();
            $("#<%=chkIsDeactivated.ClientID%>").CheckBoxX();
            if ($.QS("PageType") == "E") {

                LoadEntityTreeNew();

            }
            CheckAutoGenarateCode();
        }


        if ($("#tvCtrEnt").exists()) {
            $("#<%=txtEntity.ClientID %>").on("click", function (e) {
                     toggleEntityTree(e.target); e.stopPropagation();
                 })
                 $(document).on("click", function () { $("#tvCtrEnt").hide(); })
                 $("#tvCtrEnt").on("click", function (e) { e.stopPropagation(); });
             }

             function selectEntity(sender, args) {

                 var t = $("#<%=txtEntity.ClientID %>");
                 var n = args.get_node();

                 if (n.get_level() < 2 && n.get_value() != "None")
                     return;
                 if (n.get_value() == "None") {
                     t.val("");
                     t.removeAttr("entityid");
                 }
                 else {
                     t.val("");
                     t.val(n.get_text());
                     entityId = n.get_value();
                     entityName = n.get_text();
                     $("#<%=hdnEntityID.ClientID %>").val(n.get_value());
                  LoadEntityTree();
                  LoadEntityTreeNew();
              }
              $("#tvCtrEnt").hide();
          }


          function LoadEntityTreeNew() {

              var tree = $find("<%= tvRelated.ClientID %>");
             tree.get_nodes().clear();
             tree.trackChanges();
             var node = new Telerik.Web.UI.RadTreeNode();

             if ($.defaultVal($.QS("ID"), '') != "") {
                 node.get_attributes().setAttribute("ParentTable", EntityId);
                 node.set_text(EntityName);
                 node.set_value(EntityId);
             }
             else {
                 node.set_text(entityName);
                 node.set_value(entityId);
                 node.get_attributes().setAttribute("ParentTable", entityId);
             }


             node.set_expandMode(3);


             tree.get_nodes().add(node);
             tree.commitChanges();
         }




         function selectField(sender, args) {

             var t = $("#<%=txtFieldName.ClientID %>");
             var n = args.get_node();

             if (n.get_level() < 1 && n.get_value() != "None")
                 return;
             if (n.get_value() == "None") {
                 t.val("");

             }
             else {
                 t.val("");
                 t.val(n.get_value());
                 $("#<%=hdnFieldID.ClientID %>").val(n.get_value());
             }
             $("#tvCtrFld").hide();
         }


         function LoadEntityTree() {
             var t = $("#<%=txtFieldName.ClientID %>");
              t.val('');
              var tree = $find("<%= rtvList.ClientID %>");
             tree.get_nodes().clear();
             tree.trackChanges();
             var node = new Telerik.Web.UI.RadTreeNode();

           
                 node.set_text(entityName);
                 node.set_value(entityId);
                 node.get_attributes().setAttribute("ParentTable", entityId);
             


             node.set_expandMode(3);


             tree.get_nodes().add(node);
             tree.commitChanges();
         }


         function toggleEntityTree(txt) {
             $(txt).next().show();
         }



         function tvItems_NodePopulate(sender, args) {
             var node = args.get_node();
             var context = args.get_context();

             context["EntityID"] = node.get_attributes().getAttribute("ParentTable");
         }

         if ($("#tvCtrFld").exists()) {
             $("#<%=txtFieldName.ClientID %>").on("click", function (e) {
                 toggleEntityTree(e.target); e.stopPropagation();
             })
             $(document).on("click", function () { $("#tvCtrFld").hide(); })
             $("#tvCtrFld").on("click", function (e) { e.stopPropagation(); });
         }






    </script>

    <script type="text/javascript">

        var myFilterModel;


        function LaunchCriteriaFilter(ctl) {
            filterMode = "Criteria";
            currentFilterDiv = $(ctl).closest('tr').find('.divCriteriaFilterValue');

            var data = new Object();
            data["PageType"] = $.QS("PageType");
            data["EID"] = $("#<%=hdnEntityID.ClientID %>").val();
            data["SID"] = sid;
            if (currentFilterDiv == null)
                data["xml"] = "";
            else
                data["xml"] = currentFilterDiv.val();
            PageMethods.SetFilterSession(data, function () {
                var url = "../Meta/Filters_Add.aspx?PageMode=Settings&SID=" + sid;
                $('#<%= IfrmFilter.ClientID %>').attr('src', url);
                $("#divFilter").ShowModal();
                return false;
            });
        }


        var currentCodeDiv;
        var crtControl;

        function LaunchCriteriaCode(ctl) {


            var ent = $("#<%=hdnEntityID.ClientID %>").val();
            if (ent == "") {
                alert("Please select the Entity");
                return false;
            }

            crtControl = $(ctl);
            currentCodeDiv = $(ctl).closest('tr').find('.divCriteriaCodeValue');

            if (currentCodeDiv.val() != "") {
                var data = new Object();
                data["Data"] = currentCodeDiv.val();
                data["EID"] = $("#<%=hdnEntityID.ClientID %>").val();
                $.Notify("Loading...");
                PageMethods.SetCriteriaCode(data, onCriteriaSuccess, onCriteriaError);
                myFilterModel.addTask();
            }
            else {

                $('#ContentPlaceHolder1_rblSeries_0').attr('checked', true);
                $("#trSeries").hide();
                $("#<%= trNumberStart.ClientID %>").show();

                $find("<%= ntxtNumberStart.ClientID %>").set_value(0);

                $("#<%= txtReset.ClientID %>").val('');
                $("#<%= chkPrefill.ClientID %>").checked(false);
                $("#chkPrefixChange,#chkSuffixChange").checked(false);

                if (!$("#<%= chkPrefill.ClientID %>").checked()) {
                    $("#<%= trPrefillLen.ClientID %>").hide();
                    $("#<%= trPrefillChar.ClientID %>").hide();
                }

                $find("<%= edPrefix.ClientID %>").set_value('');
                $find("<%= edSuffix.ClientID %>").set_value('');

                $("#divAutoGenerated").ShowModal();
                myFilterModel.addTask();

            }

            return false;
        }

        function CriteriaDelete(ctl) {
            var len = $('.trCriteria').length;

            var delrow = $(ctl).closest('tr');
            if (len == 1) {

            }
            else {
                delrow.remove();
                len = len - 1;
                var crno = 1;
                $("#tblCriteria tr").each(function () {
                    $(this).find('#crno').html("Criteria No " + crno);
                    crno += 1;
                    len -= 1;
                });
            }
        }


        function AddNewCriteria(ctl) {
            var len = $("#tblCriteria").find('TR').length;
            var CrCount = $(ctl).prev().find('.trCriteria').length;
            var crClone = $("#tblCriteria tr:first").clone();
            $(crClone).find('#crno').html("Criteria No " + (len + 1));
            $(crClone).find('#crcode').html("Settings");
            $(crClone).find('.divCriteriaCodeValue').val('');
            $("#tblCriteria").append(crClone);
        }



        var currentMode;
        var currentCtl = null;
        function ShowFieldInfoTree(ctl, mode) {
            currentCtl = $(ctl);
            currentMode = mode;
            var trDiv = $("#divTree");
            $(ctl).after(trDiv);
            $("#divTree").show();
            $("#divTree").css("right", "");
            if (mode == "Prefix" || mode == "Suffix") {
                $("#divTree").css("right", "135px");
                var tv = $find("<%= tvRelated.ClientID %>");
                var dateStyle = tv.findNodeByValue("%%");
                if (dateStyle == null) {
                    tv.trackChanges();
                    //Instantiate a new client node
                    var node = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node.set_text("Date/DateTime Style");
                    node.set_value("%%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    tv.get_nodes().add(node);

                    var node_dd = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_dd.set_text("dd [e.g. 07]");
                    node_dd.set_value("%dd%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_dd);

                    var node_ddd = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_ddd.set_text("ddd [e.g. Mon]");
                    node_ddd.set_value("%ddd%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_ddd);

                    var node_dddd = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_dddd.set_text("dddd [e.g. Monday]");
                    node_dddd.set_value("%dddd%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_dddd);

                    var node_MM = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_MM.set_text("MM [e.g. 01]");
                    node_MM.set_value("%MM%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_MM);

                    var node_MMM = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_MMM.set_text("MMM [e.g. Jan]");
                    node_MMM.set_value("%MMM%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_MMM);

                    var node_MMMM = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_MMMM.set_text("MMMM [e.g. January]");
                    node_MMMM.set_value("%MMMM%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_MMMM);

                    var node_yy = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_yy.set_text("yy [e.g. 99]");
                    node_yy.set_value("%yy%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_yy);

                    var node_yyyy = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_yyyy.set_text("yyyy [e.g. 1999]");
                    node_yyyy.set_value("%yyyy%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_yyyy);

                    var node_yyyy = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_yyyy.set_text("yyyy [e.g. 1999]");
                    node_yyyy.set_value("%yyyy%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_yyyy);

                    var node_hh = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_hh.set_text("hh [e.g. 01]");
                    node_hh.set_value("%hh%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_hh);

                    var node_HH = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_HH.set_text("HH [e.g. 13]");
                    node_HH.set_value("%HH%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_HH);

                    var node_mm = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_mm.set_text("mm [e.g. 59]");
                    node_mm.set_value("%mm%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_mm);

                    var node_ss = new Telerik.Web.UI.RadTreeNode();
                    //Set its text
                    node_ss.set_text("ss [e.g. 55]");
                    node_ss.set_value("%ss%")
                    //Add the new node as the child of the selected node or the treeview if no node is selected
                    node.get_nodes().add(node_ss);

                    tv.commitChanges();
                }
            }
            else {
                var tv = $find("<%= tvRelated.ClientID %>");
                var nod = new Telerik.Web.UI.RadTreeNode();

                nod = tv.findNodeByValue("%%");
                if (nod != null) {
                    tv.trackChanges();
                    tv.get_nodes().remove(nod);
                    tv.commitChanges();
                }

            }
            return;
        }


        function CheckPrefill() {
            var chkPre = $("#<%= chkPrefill.ClientID %>");

            $("#<%= trPrefillLen.ClientID %>").hide();
            $("#<%= trPrefillChar.ClientID %>").hide();

            if (chkPre.checked()) {
                $("#<%= trPrefillLen.ClientID %>").show();
                $("#<%= trPrefillChar.ClientID %>").show();
            }
        }


        function FilterTask() {
            return { FieldID: '', Title: '', FieldName: 'Please Select', EntityPath: '', SeriesValue: '', SeriesStart: '0' };
        }

        function FilterTaskListViewModel() {
            var self = this;
            self.FilterTask = ko.observableArray(dbCols);
            self.addTask = function () {
                self.FilterTask.push(new FilterTask());
            };

            self.removeTask = function (FilterTask) {
                HideFieldInfoTree();
                self.FilterTask.remove(FilterTask);
                if ($("#tbl").children().length == 0)
                    myFilterModel.addTask();
            };
            self.removeAll = function (FilterTask) { self.FilterTask.removeAll(FilterTask); };
            self.rebind = function (arr) {
                HideFieldInfoTree();
                self.removeAll()
                for (var i = 0; i < arr.length; i++)
                    self.FilterTask.push(arr[i]);
                self.addTask();
            }

        }





        function SaveCriteriaCode() {
            var codeXMl = "";
            var series = $('#<%=rblSeries.ClientID %> input:checked').val();
            var ntxt = $find("<%= ntxtNumberStart.ClientID %>");
            var chkFill = $("#<%= chkPrefill.ClientID %>").checked();

            var chkAllowMod = $("#<%= chkAllowMod.ClientID %>").checked();

            codeXMl += " <AllowModification Value='" + chkAllowMod + "' /> ";
            //<ResetNumbering Value=""[0fc6f152-9270-41c9-8e50-54bcceb88473#category:tbl_CORE_USER_category]"" /> 
            var seriesXMLtxt = "";
            $("#tbl").find('TR').each(function () { seriesXMLtxt += CreateSeriesXml($(this)) });

            if (series == "0")
                codeXMl += " <StartFrom Mode='Simple' StartNumber='" + $find("<%= ntxtNumberStart.ClientID %>").get_value() + "' >  </StartFrom>";
            else
                codeXMl += " <StartFrom Mode='Series' > " + seriesXMLtxt + " </StartFrom> ";

            var txtReset = $("#<%= txtReset.ClientID %>").val();
            codeXMl += " <ResetNumbering Value='" + txtReset + "' ResetOnPrefix='" + ($("#chkPrefixChange").checked() ? 1 : 0) + "' ResetOnSuffix='" + ($("#chkSuffixChange").checked() ? 1 : 0) + "'  />";

            codeXMl += " <Prefill Value='" + chkFill + "' ";
            if (chkFill) {
                var prelend = $find("<%= ntxtPrefillLength.ClientID %>").get_value();
                var fillchar = $("#<%= txtPrefillChar.ClientID %>").val();

                codeXMl += " Length='" + prelend + "' PrefillChar='" + fillchar + "'  /> ";
            }
            else
                codeXMl += " Length='0' PrefillChar='0' /> ";

            var str = "";
            var pfx = $find("<%= edPrefix.ClientID %>").get_value();

            if (pfx != "") {

                str = $("<span>" + $find("<%= edPrefix.ClientID %>").get_value() + "</span>").text();

        $("<span>" + $find("<%= edPrefix.ClientID %>").get_value() + "</span>").find("A").each(function () {
            str = str.replace($(this).text(), $(this).attr("href"));
        });

        codeXMl += " <Prefix Value='" + str + "' />";
    }

    var sfx = $find("<%= edSuffix.ClientID %>").get_value();
            if (sfx != "") {

                str = "";
                str = $("<span>" + $find("<%= edSuffix.ClientID %>").get_value() + "</span>").text()

                $("<span>" + $find("<%= edSuffix.ClientID %>").get_value() + "</span>").find("A").each(function () {
                    str = str.replace($(this).text(), $(this).attr("href"));
                });

                codeXMl += " <Suffix Value='" + str + "' />";
            }

            currentCodeDiv.val(codeXMl);
            $("#divAutoGenerated").HideModal();

            return false;
        }



        function onCriteriaSuccess(data) {
            $.Notify(false);
            if (data != null) {

                if (data["SeriesData"].length > 0)
                    crtControl.text('Edit Code');

                if (data["Mode"].toLowerCase() == "series") {
                    $('#ContentPlaceHolder1_rblSeries_1').attr('checked', true);
                    $("#trSeries").show();
                    $("#<%= trNumberStart.ClientID %>").hide();
                    dbCols = [];
                    dbCols = eval(data["SeriesData"]);
                    myFilterModel.rebind(dbCols);
                }
                else {
                    $('#ContentPlaceHolder1_rblSeries_0').attr('checked', true);
                    $("#trSeries").hide();
                    $("#<%= trNumberStart.ClientID %>").show();
                    $find("<%= ntxtNumberStart.ClientID %>").set_value(data["startFrom"]);
                }

                $("#<%= txtReset.ClientID %>").val(data["ResetText"])
                $("#<%= txtReset.ClientID %>").attr("FieldID", data["ResetAttr_FieldID"]);
                $("#<%= txtReset.ClientID %>").attr("EntityPath", data["ResetAttr_EntityPath"]);
                $("#<%= txtReset.ClientID %>").attr("title", data["ResetTitle"]);

                $("#chkPrefixChange").checked(data["ResetOnPrefix"]);
                $("#chkSuffixChange").checked(data["ResetOnSuffix"]);

                $("#<%= chkPrefill.ClientID %>").checked(data["isPreFill"]);
                $("#<%= chkAllowMod.ClientID %>").checked(data["AllowModification"]);
                if (data["isPreFill"]) {
                    $("#<%= trPrefillLen.ClientID %>").show();
                    $("#<%= trPrefillChar.ClientID %>").show();
                    $find("<%= ntxtPrefillLength.ClientID %>").set_value(data["PreFillLength"]);
                    $("#<%= txtPrefillChar.ClientID %>").val(data["PreFillChar"]);
                }
                else {
                    $("#<%= trPrefillLen.ClientID %>").hide();
                    $("#<%= trPrefillChar.ClientID %>").hide();
                }

                $find("<%= edPrefix.ClientID %>").set_value(data["PrefixData"]);
                $find("<%= edSuffix.ClientID %>").set_value(data["SuffixData"]);
            }
            $("#divAutoGenerated").ShowModal();
        }

        function onCriteriaError(data) {
            $.Notify(false);
        }


        $(function () {
            $('#<%=chkPrefill.ClientID%>,#<%=chkAllowMod.ClientID%>').CheckBoxX()
        });

            function PasteCancel(sender, args) {
                if (!editorPaste)
                    args.set_cancel(true);
            }

            function HideFieldInfoTree(sender, eventArgs) {

                $(document.body).append($("#divTree").hide());
            }


            var editorPaste = false;

            function LoadTreeDatatoControls(sender, eventArgs) {
                if (eventArgs.get_node().get_nodes().get_count() != "0")
                    return;
                if (eventArgs.get_node().get_attributes().getAttribute("IsParent") == "1")
                    return;


                var node = eventArgs.get_node();
                if (node.get_level() == 0)
                    return;

                var n = node;
                var f = "";
                while (n.get_level() > 0) {
                    f = n.get_value() + "." + f;
                    if (n.get_level() == 0)
                        break;
                    else
                        n = n.get_parent();
                }
                f = f.Trim('.');
                f = "Field." + f;

                var dispname = eventArgs.get_node().get_text();
                var value = eventArgs.get_node().get_value();
                var node = eventArgs.get_node();
                var s = "";
                var title = "";
                var mainParent = "";
                var currentObject = node.get_parent();
                var entitypath = "";
                if (value.indexOf("%") > -1)
                    f = "CDATE(SYSDATE," + value + ")";

                if (currentMode == "Fields") {
                    var txtRst = $("#<%= txtReset.ClientID %>");
                    txtRst.val((txtRst.val() + "|" + f).Trim('|'));
                    txtRst.attr("title", f);

                }
                else if (currentMode == "Prefix") {
                    var editor = $find("<%= edPrefix.ClientID %>");
                    editor.set_value(editor.get_value() + f);

                }
                else if (currentMode == "Suffix") {
                    var editor = $find("<%= edSuffix.ClientID %>");
                    editor.set_value(editor.get_value() + f);

                }
                else if (currentMode == "Series") {
                    var fieldName = node.get_attributes().getAttribute("FieldName");
                    var fieldID = node.get_attributes().getAttribute("FieldID");
                    currentCtl.val(f);
                    currentCtl.attr('Title', f);
                    if (currentCtl.closest("TR").index() == currentCtl.closest("tbody").children().length - 1)
                        myFilterModel.addTask();
                }

}


function ChangeSimpleSeries() {
    var issimple = $('#ContentPlaceHolder1_rblSeries_0').attr('checked');

    if (issimple) {
        $("#trSeries").hide();
        $("#<%= trNumberStart.ClientID %>").show();
    }
    else if (!issimple) {
        $("#trSeries").show();
        $("#<%= trNumberStart.ClientID %>").hide();
            }
    }




    var isDependentFilter = 0;


    function OpenRecordFilter() {

        var data = new Object();
        data["PageType"] = $.QS("PageType");
        data["EID"] = $("#<%=hdnEntityID.ClientID %>").val();
    data["SID"] = sid;
    data["xml"] = $("#<%= hdnRecordFilter.ClientID %>").val();
        PageMethods.SetFilterSession(data, function () {
            var url = "../Meta/Filters_Add.aspx?PageMode=Settings&SID=" + sid;
            $('#<%= IfrmFilter.ClientID %>').attr('src', url);
            $("#divFilter").ShowModal();
            return false;
        });
}

function saveFilterXml(filterXml) {
    hidePopUp();

    if (isDependentFilter == 1) {
        $("#<%= hdnDependentFilter.ClientID %>").val(filterXml);
    }
    else {
        if (filterMode == "Criteria") {
            currentFilterDiv.val(filterXml);
        }
        else
            $("#<%= hdnRecordFilter.ClientID %>").val(filterXml);
    }
}

function hidePopUp() {
    $("#divFilter").HideModal();
    return false;
}


function LoadCriteriaData() {
    var criteria = "";
    var arrInfo = CriInfo.split('|||');
    myFilterModel = new FilterTaskListViewModel();
    ko.applyBindings(myFilterModel, document.getElementById('tbl'));
    for (var a = 0; a < arrInfo.length; a++) {
        var data = arrInfo[a].split('~');
        if (a == 0) {
            var crFirst = $("#tblCriteria tr:first");
            $(crFirst).find('.divCriteriaFilterValue').val(data[0]);
            $(crFirst).find('.divCriteriaCodeValue').val(data[1]);
        }
        else {
            var crClone = $("#tblCriteria tr:first").clone();
            $(crClone).find('#crno').html("Criteria No " + ((a + 1) + 1));
            $(crClone).find('.divCriteriaFilterValue').val('');
            $(crClone).find('.divCriteriaCodeValue').val('');
            $(crClone).find('.divCriteriaFilterValue').val(data[0]);
            $(crClone).find('.divCriteriaCodeValue').val(data[1]);
            $("#tblCriteria").append(crClone);

        }
    }
}

function LoadSeriesXML() {

    ko.applyBindings(myFilterModel, document.getElementById('tbl'));
    myFilterModel.addTask();
}

function CreateSeriesXml(seriesrow) {
    var row = seriesrow;
    var val = row.find(".seriesField").val();
    if ($.isEmpty(val) || val == "Please Select")
        return "";
    var rowxml = " <Series ";
    rowxml += " Key='" + row.find(".seriesField").val() + "'";

    rowxml += " Value='" + row.find(".srsValue").val() + "'";
    rowxml += " StartNumber='" + row.find(".srsNumber").val() + "' >";
    rowxml += " </Series>   ";

    return rowxml;
}


function saveData() {

    var data = new Object();
    data["Type"] = "SaveAutoGenerateCode";

    var criteria = "";
    var criteriadata = "";
    $("#tblCriteria").find('TR').each(function () {
        criteria += "<Criteria>" + $(this).find('.divCriteriaFilterValue').val() + "" + $(this).find('.divCriteriaCodeValue').val() + "</Criteria>";
    });

    data["@Entity"] = $("#<%=hdnEntityID.ClientID %>").val();
    data["@FieldName"] = $("#<%=txtFieldName.ClientID %>").val();
    data["@DisableAutoCode"] = $("#<%=chkDisableAutoCode.ClientID%>").checked();
    data["@CodeInfo"] = "<Settings>" + criteria + "</Settings>";
    data["@IsDeactivated"] = $("#<%=chkIsDeactivated.ClientID%>").checked();
    data["@AutoCodes_Pid"] = AutoCodeID;
    data["au"] = $.QS("_au");
    $.Notify("Saving");
    PageMethods.SaveAutoGenerateCode(data, PageMethodSuccess, PageMethodError);
    return false;
}

function PageMethodSuccess(data) {
    $.Notify(false);
    AutoCodeID = data["@AutoCodes_Pid"];;
    RefreshParent(true);
}
function PageMethodError(error) {
    $.Notify({ Message: "Error Occured.", NotifyOnly: true });
}

$(document).click(function (e) {

    if ($("#divTree").isVisible() && !$(e.srcElement).closest("#divTree").exists() && (!$(e.srcElement).hasClass("LiveTree")) && (!$(e.srcElement).hasClass("divTreeButton")) && (!$(e.srcElement).hasClass("seriesField"))) {
        $(document.body).append($("#divTree").hide());
    }
});


function CheckAutoGenarateCode() {
    if ($("#<%=chkDisableAutoCode.ClientID%>").checked())
                    $("#<%=trCriteria.ClientID%>").hide();
                else
                    $("#<%=trCriteria.ClientID%>").show();

            }





    </script>




</asp:Content>


